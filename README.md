# Dona - Social Data Gathering Platform
A Next.js platform for collecting and de-identifying social data to support research on mental wellbeing.

The previous version of the application is available in the legacy repository: https://github.com/mbp-lab/dona


## Table of Contents
- [Overview](#overview)
- [Repository architecture](#repository-architecture)
- [Prerequisites](#prerequisites)
- [Environment variables](#environment-variables)
- [Local development (host machine, dev mode)](#local-development-host-machine-dev-mode)
- [Local development in containers (docker-compose)](#local-development-in-containers-docker-compose)
- [Deployment](#deployment)
- [Database and migrations (Drizzle)](#database-and-migrations-drizzle)
- [Troubleshooting and tips](#troubleshooting-and-tips)
- [Maintenance](#maintenance)


## Overview
- **Tech stack**: Next.js 15 (App Router), React 19, TypeScript, Drizzle ORM + PostgreSQL, next-intl, PNPM, Docker.
- **Primary features**: local-first data processing, pseudonymization, donation workflow, analytics previews.


## Repository architecture
- `drizzle/` — SQL migrations generated by drizzle-kit (must be checked in)
- `drizzle.config.ts` — Drizzle CLI configuration
- `src/db/` — Database client and schema
  - `drizzle.ts` — Postgres connection and db instance
  - `schema.ts` — Drizzle schema and relations (source of truth for migrations)
- `src/app/` — Next.js App Router pages and server actions
  - `data-donation/` — Donation workflow pages and server actions
- `src/services/` — Non-UI services (e.g., range filtering, validation)
- `src/components/` — Reusable React components
- `locales/` — i18n messages for next-intl
- `public/` — Static assets (including sql.js wasm)
- `docker-compose.yml` / `Dockerfile` — Containerization and orchestration
- `jest.config.ts` / `jest.setup.js` — Unit testing setup


## Prerequisites
- Node 22+ and PNPM installed
- Docker (for containerized workflows and PostgreSQL)


## Environment variables
Create a `.env` file in the project root. Common variables:
- `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD` — used by docker-compose for local DB
- `DATABASE_URL` — Postgres connection string used by the app (compose sets this automatically for the containerized app)
- `DONOR_ID_INPUT_METHOD`, `DONOR_SURVEY_ENABLED`, `FEEDBACK_SURVEY_ENABLED`, `DONOR_SURVEY_LINK`, `FEEDBACK_SURVEY_LINK` — feature flags/links
- Ports (configurable):
  - `APP_PORT` — host port to bind the web app to in docker-compose (default: `3000`)
  - `APP_INTERNAL_PORT` — container/internal port the Next.js server listens on (default: `3000`)
  - `POSTGRES_HOST_PORT` — host port to bind Postgres to (default: `5432`)
  - Note: Next.js also respects the standard `PORT` environment variable. In docker-compose we automatically set `PORT` to `APP_INTERNAL_PORT`.

Example `.env` snippet:
```env
POSTGRES_DB=dona
POSTGRES_USER=dona
POSTGRES_PASSWORD=password
POSTGRES_HOST_PORT=5432
APP_PORT=3000
APP_INTERNAL_PORT=3000
# App config
DONOR_ID_INPUT_METHOD=auto
DONOR_SURVEY_ENABLED=false
FEEDBACK_SURVEY_ENABLED=false
DONOR_SURVEY_LINK=
FEEDBACK_SURVEY_LINK=
```


## Local development (host machine, dev mode)
This runs Next.js directly on your machine. You can still use Docker for the database.

1) Install dependencies
```bash
pnpm install
```

2) Start PostgreSQL via Docker (recommended for dev)
```bash
docker compose up -d postgres
```
This launches Postgres on `localhost:${POSTGRES_HOST_PORT:-5432}` with data persisted in the `postgres-data` volume.

3) Set `DATABASE_URL`
In `.env`, ensure `DATABASE_URL` points to your local Docker Postgres, e.g.
```env
DATABASE_URL=postgres://<user>:<password>@localhost:${POSTGRES_HOST_PORT:-5432}/<db>
```
The compose service defaults map to:
```env
postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@localhost:5432/$POSTGRES_DB
```

4) Apply database migrations
```bash
pnpm drizzle-kit migrate
```

5) Run the dev server
- Option A: default port 3000
```bash
pnpm dev
```
- Option B: custom port
```bash
PORT=3001 pnpm dev
```
Then open http://localhost:3001

6) Run tests
```bash
pnpm test
```


## Local development in containers (docker-compose)
This runs both Postgres and the app in containers. Ports are configurable.

1) Set optional port overrides in `.env` (or export in your shell)
```env
APP_PORT=3000              # host port for the app
APP_INTERNAL_PORT=3000     # port inside the app container
POSTGRES_HOST_PORT=5432    # host port for Postgres
```

2) Launch all services
```bash
docker compose up  # add -d to run detached
```
- The app will be available at `http://localhost:${APP_PORT:-3000}`
- The app container will receive `PORT=${APP_INTERNAL_PORT:-3000}`

3) Apply migrations automatically
- The app container runs `pnpm drizzle-kit migrate` before start.

4) Stop/teardown
```bash
docker compose stop        # stop containers
docker compose down        # remove containers
docker volume rm dona-prod_postgres-data  # remove data (irreversible)
```


## Deployment
Choose one of the following depending on your target environment.

### Option A: Build and run locally (no containers)
```bash
pnpm install
pnpm build
# Apply migrations to your target database
DATABASE_URL=postgres://... pnpm drizzle-kit migrate
# Start the production server
PORT=3000 pnpm start
```
Visit http://localhost:3000 (or your chosen `PORT`).

### Option B: Docker image
Build the image:
```bash
docker build -t dona:latest .
```
Run with Postgres in docker-compose (recommended):
```bash
# Configure .env as needed
docker compose up -d
```
Or run the app container standalone (provide `DATABASE_URL` and `PORT`):
```bash
docker run --rm \
  -e DATABASE_URL=postgres://... \
  -e PORT=3000 \
  -p 3000:3000 \
  dona:latest
```


## Database and migrations (Drizzle)
Installed packages
1) drizzle-orm — ORM
2) drizzle-kit — CLI for migrations
3) pg — Postgres driver

Key files
- `drizzle.config.ts` — CLI configuration (schema paths, out dir)
- `drizzle/` — migrations generated by drizzle-kit (commit these)
- `src/db/drizzle.ts` — initializes the Postgres client and exports `db`
- `src/db/schema.ts` — schema definitions; migrations are generated from changes here

Common commands
```bash
pnpm drizzle-kit generate                # generate migrations from schema changes
pnpm drizzle-kit migrate                 # apply migrations to the database in DATABASE_URL
pnpm drizzle-kit generate --custom --name=my-custom-migration
```

Relations and schema notes
- `donations` has many `conversations`
- `data_sources` has many `conversations`
- `conversations` has one `donation`, one `data_source`, many `participants`, many `messages`, many `messages_audio`
- `conversation_participants` has one `conversation`
- `messages` and `messages_audio` each have one `conversation`


## Troubleshooting and tips
- If you change `APP_INTERNAL_PORT`, remember that Next.js reads `PORT`. In docker-compose this is set automatically from `APP_INTERNAL_PORT`.
- For host development, use `PORT` when running `pnpm dev` or `pnpm start` to change the port.
- If migrations fail, verify `DATABASE_URL` and that the Postgres container is healthy.
- `next-intl` requires an initial locale; ensure locales are present under `/locales`.
- `sql.js` requires wasm files; prepare is handled via the `prepare` script.


## Maintenance
- Keep pnpm up to date: `pnpm self-update`
- Update dependencies within range: `pnpm update`
- Check for outdated packages: `pnpm outdated`
- Investigate dependency usage: `pnpm why <package-name>`
- Always run tests and the app after updates: `pnpm test`; `pnpm dev` or `pnpm start`
